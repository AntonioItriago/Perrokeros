<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ Perrokeros - Pedido por WhatsApp</title>
    <style>
        /* Estilos generales */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f8f8f8; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Encabezado con Logo */
        .header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #558B2F; padding-bottom: 10px; }
        .header img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid #558B2F; }
        .header h1 { margin: 0; color: #33691E; font-size: 1.8em; }

        h2 { color: #558B2F; border-bottom: 1px dashed #558B2F; padding-bottom: 5px; margin-top: 25px; }

        /* Estilos de productos y controles */
        .producto { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dotted #eee; }
        .producto-info { flex-grow: 1; }
        .producto-info h4 { margin: 0; font-size: 1.1em; color: #333; }
        .producto-info p { margin: 2px 0 0; font-size: 0.9em; color: #777; }
        .producto-precio { font-weight: bold; color: #FBC02D; margin-left: 15px; width: 60px; text-align: right; font-size: 1.1em; }
        .controls { display: flex; align-items: center; gap: 5px; }
        .controls button { 
            background-color: #558B2F; /* Verde principal */
            color: white; border: none; padding: 5px 10px; 
            cursor: pointer; border-radius: 4px; transition: background-color 0.3s; 
        }
        .controls button:hover { background-color: #33691E; }
        .controls input { width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 4px; }
        
        /* Estilos del Total y Bot√≥n */
        .total-container { 
            margin-top: 25px; padding: 15px; background-color: #E8F5E9; /* Verde muy claro */
            border: 1px solid #C8E6C9; border-radius: 4px; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .total-container span { font-size: 1.4em; color: #33691E; font-weight: bold; }
        .btn-ordenar { 
            background-color: #25D366; /* Verde WhatsApp */
            color: white; border: none; padding: 12px 20px; font-size: 1.1em; 
            border-radius: 6px; cursor: pointer; margin-top: 15px; width: 100%; 
            transition: background-color 0.3s; font-weight: bold;
        }
        .btn-ordenar:hover { background-color: #1EBE4A; }

        /* Estilos de Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%;
            text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .modal-content h3 { color: #558B2F; }
        .modal-content ul { list-style: none; padding: 0; text-align: left; margin-bottom: 20px; }
        .modal-content ul li { padding: 8px 0; border-bottom: 1px dotted #ddd; display: flex; justify-content: space-between; }
        .modal-content .total { font-size: 1.2em; font-weight: bold; color: #33691E; margin-top: 10px; }
        .modal-content .btn-whatsapp { background-color: #25D366; }
        .modal-content .btn-whatsapp:hover { background-color: #1EBE4A; }

        /* Estilos de Confirmaci√≥n */
        #confirmacion-modal .modal-content { padding: 20px; max-width: 300px; z-index: 101; }
        #confirmacion-modal h3 { color: #25D366; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <img src="logo_perrokeros.jpg" alt="Logo Perrokeros">
            <h1>Men√∫ Perrokeros üê∂</h1>
        </div>

        <div id="menu-secciones">
            <p>Cargando men√∫...</p>
        </div>
        
        <div class="total-container">
            <div>Total estimado del pedido:</div>
            <span><span id="total-currency-code">$</span><span id="total">0.00</span></span>
        </div>

        <button class="btn-ordenar" onclick="mostrarResumen()">Generar Orden por WhatsApp</button>
    </div>

    <div id="resumen-modal" class="modal">
        <div class="modal-content">
            <h3>üìù Resumen de tu Pedido</h3>
            <ul id="resumen-lista"></ul>
            <p class="total">Total: <span id="resumen-total-currency-code">$</span><span id="resumen-total">0.00</span></p>
            <button class="btn-ordenar btn-whatsapp" onclick="enviarPedidoWhatsApp()">üìû Ordenar por WhatsApp</button>
            <button class="btn-ordenar" style="background-color: #777;" onclick="cerrarResumen()">Volver al Men√∫</button>
        </div>
    </div>

    <div id="confirmacion-modal" class="modal">
        <div class="modal-content">
            <h3>‚úÖ ¬°Orden en proceso!</h3>
            <p>Revisa tu WhatsApp para confirmar y finalizar la compra.</p>
            <button onclick="cerrarConfirmacion()" class="btn-ordenar" style="width: 50%; margin: 15px auto 0;">ACEPTAR</button>
        </div>
    </div>

    <script>
        // *** CONFIGURACI√ìN CLAVE ***
        // Reemplaza con tu n√∫mero de WhatsApp
        const NUMERO_WHATSAPP = '584122525407'; 

        // URL del Google Sheets publicado en formato TSV (separado por tabuladores)
        const TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRA3DaYat0bjeFAaBSCJqykmEyGxFF1lgCLVfBLpbH6GU_m70co9bwgDrn34d4DoTnz3TkQm7LNvlWy/pub?gid=1090552327&single=true&output=tsv'; 
        // --------------------------------------------------------------------

        let productosDB = {}; 
        const carrito = {};
        let currencyCode = '$'; // S√≠mbolo de moneda por defecto

        // --- FUNCIONES CENTRALES DE CARGA Y PROCESAMIENTO (ADAPTADAS A TSV) ---

        async function cargarMenu() {
            document.getElementById('menu-secciones').innerHTML = '<p>Intentando cargar men√∫ de Perrokeros...</p>';
            try {
                // 1. Descarga el archivo TSV
                const response = await fetch(TSV_URL);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}. ¬øEst√° bien publicada la URL?`);
                }
                const tsvText = await response.text();
                
                console.log("--- DEBUG: TSV TEXTO COMPLETO ---");
                // console.log(tsvText); // Descomentar para ver el texto crudo en consola
                
                // 2. Procesa el texto TSV
                productosDB = parsearTSV(tsvText);

                // 3. Renderiza y calcula
                renderizarMenu();
                actualizarTotal();
            } catch (error) {
                console.error("Error en cargarMenu:", error);
                document.getElementById('menu-secciones').innerHTML = '<h2>üê∂ ¬°Error! No se pudo cargar el men√∫.</h2><p>Verifica la URL, el formato TSV y revisa la Consola del navegador (F12) para detalles.</p>';
            }
        }
        
        function parsearTSV(tsv) {
            const data = {};
            const lineas = tsv.replace(/\r/g, '').split('\n');
            
            console.log("DEBUG: N√∫mero total de l√≠neas (incluyendo encabezados):", lineas.length);

            // Omitimos la primera l√≠nea (encabezados)
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (linea.length === 0) continue; 

                // *** CAMBIO CLAVE: Usar '\t' (tabulador) como separador ***
                const columnas = linea.split('\t'); 
                
                // El nuevo orden de columnas: id, name, price, currency, description, category, image_url, is_active, created_at
                if (columnas.length < 6) { // M√≠nimo para ID, Nombre, Precio, Moneda, Descripci√≥n y Categor√≠a
                    // console.error("DEBUG: L√≠nea ignorada (menos de 6 columnas esperadas):", linea); // Descomentar para debug
                    continue; 
                }

                try {
                    // Mapeo de las columnas TSV
                    const [id, nombre, precioStr, currency, desc, categoria] = columnas.slice(0, 6).map(c => c.trim().replace(/"/g, ''));
                    
                    if (!id || !precioStr || !categoria) {
                        console.error("DEBUG: Fila con campos vac√≠os esenciales (ID, PRECIO o CATEGOR√çA):", linea);
                        continue;
                    }
                    
                    const precio = parseFloat(precioStr);
                    if (isNaN(precio)) {
                        console.error("DEBUG: FALLO: El PRECIO no es un n√∫mero. Precio recibido:", precioStr, "en l√≠nea:", linea);
                        continue;
                    }

                    if (currency) {
                        currencyCode = currency; // Se usa el c√≥digo de la primera fila v√°lida para todo el men√∫
                    }

                    const producto = { id, nombre, precio, desc, categoria, currency: currencyCode };

                    // Agrupa por Categor√≠a
                    if (!data[categoria]) {
                        data[categoria] = [];
                    }
                    data[categoria].push(producto);
                    
                } catch (e) {
                    console.error("DEBUG: Error inesperado al procesar l√≠nea:", linea, e);
                }
            }
            console.log("DEBUG: Datos procesados (productosDB):", data);
            return data;
        }


        // --- FUNCIONES DE RENDERIZADO Y L√ìGICA (RESTO DEL C√ìDIGO) ---

        function renderizarMenu() {
            const menuDiv = document.getElementById('menu-secciones');
            let html = '';
            
            // Actualiza el s√≠mbolo de moneda en la interfaz
            document.getElementById('total-currency-code').textContent = currencyCode;
            document.getElementById('resumen-total-currency-code').textContent = currencyCode;

            // Itera sobre las categor√≠as obtenidas
            for (const seccion in productosDB) {
                html += `<h2>${seccion}</h2><div class="menu-section">`;
                productosDB[seccion].forEach(p => {
                    carrito[p.id] = 0; // Inicializa el carrito
                    html += `<div class="producto">
                                <div class="producto-info">
                                    <h4>${p.nombre}</h4>
                                    <p>${p.desc}</p>
                                </div>
                                <div class="producto-precio">${p.currency}${p.precio.toFixed(2)}</div>
                                <div class="controls">
                                    <button onclick="cambiarCantidad('${p.id}', -1)">-</button>
                                    <input type="number" id="cant-${p.id}" value="0" min="0" onchange="actualizarCarrito(this, '${p.id}')">
                                    <button onclick="cambiarCantidad('${p.id}', 1)">+</button>
                                </div>
                            </div>`;
                });
                html += '</div>';
            }
            menuDiv.innerHTML = html;
        }

        function cambiarCantidad(id, cambio) {
            const input = document.getElementById(`cant-${id}`);
            let nuevaCantidad = parseInt(input.value) + cambio;
            if (nuevaCantidad < 0) nuevaCantidad = 0;
            input.value = nuevaCantidad;
            carrito[id] = nuevaCantidad; 
            actualizarTotal();
        }

        function actualizarCarrito(inputElement, id) {
            let nuevaCantidad = parseInt(inputElement.value);
            if (isNaN(nuevaCantidad) || nuevaCantidad < 0) {
                nuevaCantidad = 0;
                inputElement.value = 0; 
            }
            carrito[id] = nuevaCantidad; 
            actualizarTotal();
        }

        function obtenerItemsPedidos() {
            const itemsPedidos = [];
            // Itera sobre todas las categor√≠as
            for (const seccion in productosDB) {
                // Itera sobre los productos en cada categor√≠a
                productosDB[seccion].forEach(p => {
                    const cantidad = carrito[p.id];
                    if (cantidad > 0) {
                        const precio = p.precio; 
                        const subtotal = cantidad * precio;
                        itemsPedidos.push({ 
                            nombre: p.nombre, 
                            cantidad: cantidad, 
                            subtotal: subtotal,
                            currency: p.currency // Agrega la moneda
                        });
                    }
                });
            }
            return itemsPedidos;
        }

        function actualizarTotal() {
            let totalGeneral = 0;
            obtenerItemsPedidos().forEach(item => { totalGeneral += item.subtotal; });
            document.getElementById('total').textContent = totalGeneral.toFixed(2);
        }

        // --- Funciones de Modal y WhatsApp ---

        function mostrarResumen() {
            const itemsPedidos = obtenerItemsPedidos();
            const modal = document.getElementById('resumen-modal');

            if (itemsPedidos.length === 0) {
                alert('¬°Tu carrito est√° vac√≠o! Agrega productos para generar una orden.');
                return;
            }

            // Mapea la lista de elementos para el modal de resumen
            document.getElementById('resumen-lista').innerHTML = itemsPedidos.map(item => 
                `<li>**${item.cantidad}x** ${item.nombre} <span style="float:right; font-weight: bold;">${item.currency}${item.subtotal.toFixed(2)}</span></li>`
            ).join('');

            document.getElementById('resumen-total').textContent = document.getElementById('total').textContent;
            modal.style.display = 'flex';
        }

        function cerrarResumen() {
            document.getElementById('resumen-modal').style.display = 'none';
        }

        function cerrarConfirmacion() {
            document.getElementById('confirmacion-modal').style.display = 'none';
        }

        function enviarPedidoWhatsApp() {
            const items = obtenerItemsPedidos();
            const total = document.getElementById('total').textContent;
            const simboloMoneda = currencyCode;

            let mensaje = `üêæ ¬°Hola, Perrokeros! Quiero realizar un pedido:\n\n`;
            items.forEach(item => { mensaje += `* ${item.cantidad}x ${item.nombre}\n`; });
            
            mensaje += `\n*TOTAL ESTIMADO: ${simboloMoneda}${total}*`;
            mensaje += '\n\nPor favor, necesito confirmar el pedido y los detalles de pago. ¬°Gracias! ü¶¥';

            const mensajeCodificado = encodeURIComponent(mensaje);
            // Crea el enlace de WhatsApp
            const urlWhatsApp = `https://wa.me/${NUMERO_WHATSAPP}?text=${mensajeCodificado}`;
            
            window.open(urlWhatsApp, '_blank');
            cerrarResumen();
            document.getElementById('confirmacion-modal').style.display = 'flex';
        }

        // El script se inicia llamando a la funci√≥n de carga
        window.onload = cargarMenu; 

    </script>

</body>
</html>
