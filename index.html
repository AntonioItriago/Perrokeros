<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ Perrokeros - Pedido por WhatsApp</title>
    <style>
        /* Estilos CSS Base */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f8f8f8; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Encabezado con Logo */
        .header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #558B2F; padding-bottom: 10px; }
        .header img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid #558B2F; }
        .header h1 { margin: 0; color: #33691E; font-size: 1.8em; }

        /* Estilos para el Carrusel/Pesta√±as */
        .menu-tabs {
            display: flex;
            overflow-x: auto; /* Permite desplazamiento lateral en caso de muchas pesta√±as */
            -webkit-overflow-scrolling: touch;
            border-bottom: 2px solid #558B2F;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .tab-button {
            background-color: #E8F5E9;
            color: #33691E;
            border: 1px solid #C8E6C9;
            border-bottom: none;
            padding: 8px 15px;
            cursor: pointer;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            margin-right: 5px;
            transition: background-color 0.3s, color 0.3s;
            flex-shrink: 0; /* Evita que los botones se achiquen */
            font-weight: 600;
            font-size: 0.9em;
        }
        .tab-button.active {
            background-color: #558B2F;
            color: white;
            border-color: #558B2F;
        }
        .menu-section-content {
            display: none; /* Oculta todas las secciones por defecto */
            padding-top: 10px;
        }
        .menu-section-content.active {
            display: block; /* Muestra solo la secci√≥n activa */
        }
        h2 { display: none; } /* Ocultamos el h2 para usar las pesta√±as */

        /* Estilos de productos y controles */
        .producto { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dotted #eee; }
        .producto-info { flex-grow: 1; }
        .producto-info h4 { margin: 0; font-size: 1.1em; color: #333; }
        .producto-info p { margin: 2px 0 0; font-size: 0.9em; color: #777; }
        .producto-precio { font-weight: bold; color: #FBC02D; margin-left: 15px; width: 60px; text-align: right; font-size: 1.1em; }
        .controls { display: flex; align-items: center; gap: 5px; }
        .controls button { 
            background-color: #558B2F; 
            color: white; border: none; padding: 5px 10px; 
            cursor: pointer; border-radius: 4px; transition: background-color 0.3s; 
        }
        .controls button:hover { background-color: #33691E; }
        .controls input { width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 4px; }
        
        /* Estilos del Total y Bot√≥n */
        .total-container { 
            margin-top: 25px; padding: 15px; background-color: #E8F5E9; 
            border: 1px solid #C8E6C9; border-radius: 4px; 
            display: flex; flex-direction: column; 
            align-items: flex-start;
        }
        .total-item { 
            width: 100%; display: flex; justify-content: space-between; margin-bottom: 5px;
        }
        .total-item span { font-size: 1.4em; color: #33691E; font-weight: bold; }
        .bs-rate { font-size: 0.8em; color: #888; margin-top: 5px; } /* Estilo para la tasa BCV */

        .btn-ordenar { 
            background-color: #25D366; 
            color: white; border: none; padding: 12px 20px; font-size: 1.1em; 
            border-radius: 6px; cursor: pointer; margin-top: 15px; width: 100%; 
            transition: background-color 0.3s; font-weight: bold;
        }
        .btn-ordenar:hover { background-color: #1EBE4A; }

        /* Estilos de Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%;
            text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .modal-content h3 { color: #558B2F; }
        .modal-content ul { list-style: none; padding: 0; text-align: left; margin-bottom: 20px; }
        .modal-content ul li { padding: 8px 0; border-bottom: 1px dotted #ddd; display: flex; justify-content: space-between; }
        .modal-content .total { font-size: 1.2em; font-weight: bold; color: #33691E; margin-top: 10px; }
        .modal-content .bs-total { font-size: 1em; color: #555; margin-top: 5px; } 

        .modal-content .btn-whatsapp { background-color: #25D366; }
        .modal-content .btn-whatsapp:hover { background-color: #1EBE4A; }

        /* Estilos de Confirmaci√≥n */
        #confirmacion-modal .modal-content { padding: 20px; max-width: 300px; z-index: 101; }
        #confirmacion-modal h3 { color: #25D366; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <img src="logo_perrokeros.jpg" alt="Logo Perrokeros">
            <h1>Men√∫ Perrokeros üê∂</h1>
        </div>

        <div id="menu-tabs-buttons" class="menu-tabs">
            </div>

        <div id="menu-secciones">
            <p>Cargando men√∫...</p>
        </div>
        
        <div class="total-container">
            <div class="total-item">
                <div>Total estimado del pedido:</div>
                <span><span id="total-currency-code">$</span><span id="total-usd">0.00</span></span>
            </div>
            
            <div class="total-item">
                <div>Total en Bol√≠vares (Bs.):</div>
                <span>Bs. <span id="total-bs">0.00</span></span>
            </div>

            <div class="bs-rate">
                *Tasa BCV: 1 USD = Bs. <span id="bcv-rate-display"></span>
            </div>
        </div>

        <button class="btn-ordenar" onclick="mostrarResumen()">Generar Orden por WhatsApp</button>
    </div>

    <div id="resumen-modal" class="modal">
        <div class="modal-content">
            <h3>üìù Resumen de tu Pedido</h3>
            <ul id="resumen-lista"></ul>
            <p class="total">Total USD: <span id="resumen-total-currency-code">$</span><span id="resumen-total-usd">0.00</span></p>
            <p class="bs-total">Total Bs.: Bs. <span id="resumen-total-bs">0.00</span></p>
            <button class="btn-ordenar btn-whatsapp" onclick="enviarPedidoWhatsApp()">üìû Ordenar por WhatsApp</button>
            <button class="btn-ordenar" style="background-color: #777;" onclick="cerrarResumen()">Volver al Men√∫</button>
        </div>
    </div>

    <div id="confirmacion-modal" class="modal">
        <div class="modal-content">
            <h3>‚úÖ ¬°Orden en proceso!</h3>
            <p>Revisa tu WhatsApp para confirmar y finalizar la compra.</p>
            <button onclick="cerrarConfirmacion()" class="btn-ordenar" style="width: 50%; margin: 15px auto 0;">ACEPTAR</button>
        </div>
    </div>

    <script>
        // *** CONFIGURACI√ìN CLAVE ***
        const NUMERO_WHATSAPP = '584122525407'; 
        const TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRA3DaYat0bjeFAaBSCJqykmEyGxFF1lgCLVfBLpbH6GU_m70co9bwgDrn34d4DoTnz3TkQm7LNvlWy/pub?gid=1090552327&single=true&output=tsv'; 
        
        // TASA OFICIAL BCV (Ahora es una variable din√°mica)
        let BCV_RATE_ACTUAL = 0; // Se inicializa en 0 y se carga al inicio.
        
        let productosDB = {}; 
        const carrito = {};
        let currencyCode = '$'; 

        // --- NUEVA FUNCI√ìN: Obtiene la Tasa BCV (SIMULADA) ---
        async function obtenerTasaBCV() {
            // SIMULACI√ìN DE API: Se usa un valor real (actualizado al 03/12/2025)
            // En producci√≥n, este valor deber√≠a ser obtenido de un servicio de scraping 
            // del BCV, ya que el BCV no tiene API p√∫blica.
            const tasaSimulada = 249.1989; 
            
            // Retorna la tasa (o el valor de fallback si la llamada fallara)
            return tasaSimulada; 
        }

        // --- FUNCIONES CENTRALES DE CARGA Y PROCESAMIENTO ---

        async function cargarMenu() {
            document.getElementById('menu-secciones').innerHTML = '<p>Intentando cargar men√∫ de Perrokeros...</p>';
            try {
                // 1. OBTENER LA TASA BCV
                BCV_RATE_ACTUAL = await obtenerTasaBCV();
                document.getElementById('bcv-rate-display').textContent = BCV_RATE_ACTUAL.toFixed(4);

                // 2. Cargar el men√∫
                const response = await fetch(TSV_URL);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}. ¬øEst√° bien publicada la URL?`);
                }
                const tsvText = await response.text();
                productosDB = parsearTSV(tsvText);
                renderizarMenu();
                actualizarTotal();
            } catch (error) {
                console.error("Error en cargarMenu:", error);
                document.getElementById('menu-secciones').innerHTML = '<h2>üê∂ ¬°Error! No se pudo cargar el men√∫.</h2><p>Verifica la URL, el formato TSV y revisa la Consola del navegador (F12) para detalles.</p>';
            }
        }
        
        function parsearTSV(tsv) {
            const data = {};
            const lineas = tsv.replace(/\r/g, '').split('\n');
            
            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (linea.length === 0) continue; 

                const columnas = linea.split('\t'); 
                
                if (columnas.length < 6) continue; 

                try {
                    const [id, nombre, precioStr, currency, desc, categoria] = columnas.slice(0, 6).map(c => c.trim().replace(/"/g, ''));
                    
                    if (!id || !precioStr || !categoria) continue;
                    
                    const precio = parseFloat(precioStr);
                    if (isNaN(precio)) continue;

                    if (currency) {
                        currencyCode = currency; 
                    }

                    const producto = { id, nombre, precio, desc, categoria, currency: currencyCode };

                    if (!data[categoria]) {
                        data[categoria] = [];
                    }
                    data[categoria].push(producto);
                    
                } catch (e) {
                    console.error("DEBUG: Error inesperado al procesar l√≠nea:", linea, e);
                }
            }
            return data;
        }

        // --- FUNCIONES DE RENDERIZADO Y L√ìGICA (ACTUALIZADAS PARA EL CARRUSEL) ---

        function renderizarMenu() {
            const menuDiv = document.getElementById('menu-secciones');
            const tabsDiv = document.getElementById('menu-tabs-buttons');
            let menuHTML = '';
            let tabsHTML = '';
            let isFirst = true;
            
            document.getElementById('total-currency-code').textContent = currencyCode;
            document.getElementById('resumen-total-currency-code').textContent = currencyCode;

            for (const seccion in productosDB) {
                const sectionId = seccion.replace(/\s/g, '-').toLowerCase(); // ID √∫nico para la secci√≥n

                // 1. Renderiza el bot√≥n de la pesta√±a
                tabsHTML += `<button class="tab-button ${isFirst ? 'active' : ''}" onclick="mostrarSeccion('${sectionId}', this)">${seccion}</button>`;
                
                // 2. Renderiza el contenido de la secci√≥n
                menuHTML += `<div id="${sectionId}" class="menu-section-content ${isFirst ? 'active' : ''}">`;
                
                productosDB[seccion].forEach(p => {
                    carrito[p.id] = 0; 
                    menuHTML += `<div class="producto">
                            <div class="producto-info">
                                <h4>${p.nombre}</h4>
                                <p>${p.desc}</p>
                            </div>
                            <div class="producto-precio">${p.currency}${p.precio.toFixed(2)}</div>
                            <div class="controls">
                                <button onclick="cambiarCantidad('${p.id}', -1)">-</button>
                                <input type="number" id="cant-${p.id}" value="0" min="0" onchange="actualizarCarrito(this, '${p.id}')">
                                <button onclick="cambiarCantidad('${p.id}', 1)">+</button>
                            </div>
                        </div>`;
                });
                menuHTML += '</div>'; // Cierra menu-section-content
                
                isFirst = false;
            }
            
            tabsDiv.innerHTML = tabsHTML;
            menuDiv.innerHTML = menuHTML;
        }

        function mostrarSeccion(sectionId, clickedButton) {
            // Oculta todas las secciones
            document.querySelectorAll('.menu-section-content').forEach(section => {
                section.classList.remove('active');
            });

            // Desactiva todos los botones de pesta√±a
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Muestra la secci√≥n seleccionada y activa el bot√≥n
            document.getElementById(sectionId).classList.add('active');
            clickedButton.classList.add('active');
        }

        function cambiarCantidad(id, cambio) {
            const input = document.getElementById(`cant-${id}`);
            let nuevaCantidad = parseInt(input.value) + cambio;
            if (nuevaCantidad < 0) nuevaCantidad = 0;
            input.value = nuevaCantidad;
            carrito[id] = nuevaCantidad; 
            actualizarTotal();
        }

        function actualizarCarrito(inputElement, id) {
            let nuevaCantidad = parseInt(inputElement.value);
            if (isNaN(nuevaCantidad) || nuevaCantidad < 0) {
                nuevaCantidad = 0;
                inputElement.value = 0; 
            }
            carrito[id] = nuevaCantidad; 
            actualizarTotal();
        }

        function obtenerItemsPedidos() {
            const itemsPedidos = [];
            for (const seccion in productosDB) {
                productosDB[seccion].forEach(p => {
                    const cantidad = carrito[p.id];
                    if (cantidad > 0) {
                        const precio = p.precio; 
                        const subtotal = cantidad * precio;
                        itemsPedidos.push({ 
                            nombre: p.nombre, 
                            cantidad: cantidad, 
                            subtotal: subtotal,
                            currency: p.currency
                        });
                    }
                });
            }
            return itemsPedidos;
        }

        // --- FUNCI√ìN CLAVE: CALCULA AMBOS TOTALES (USA BCV_RATE_ACTUAL) ---
        function actualizarTotal() {
            let totalGeneralUSD = 0;
            obtenerItemsPedidos().forEach(item => { totalGeneralUSD += item.subtotal; });
            
            // C√°lculo en Bol√≠vares usando la tasa BCV actualizada
            const totalGeneralBS = totalGeneralUSD * BCV_RATE_ACTUAL;

            // Actualiza la interfaz USD
            document.getElementById('total-usd').textContent = totalGeneralUSD.toFixed(2);
            
            // Actualiza la interfaz BS (dos decimales)
            document.getElementById('total-bs').textContent = totalGeneralBS.toFixed(2);
        }

        // --- Funciones de Modal y WhatsApp ---

        function mostrarResumen() {
            const itemsPedidos = obtenerItemsPedidos();
            const modal = document.getElementById('resumen-modal');

            if (itemsPedidos.length === 0) {
                alert('¬°Tu carrito est√° vac√≠o! Agrega productos para generar una orden.');
                return;
            }

            document.getElementById('resumen-lista').innerHTML = itemsPedidos.map(item => 
                `<li>**${item.cantidad}x** ${item.nombre} <span style="float:right; font-weight: bold;">${item.currency}${item.subtotal.toFixed(2)}</span></li>`
            ).join('');

            // Pasa ambos totales al modal
            const totalUSD = document.getElementById('total-usd').textContent;
            const totalBS = document.getElementById('total-bs').textContent;

            document.getElementById('resumen-total-usd').textContent = totalUSD;
            document.getElementById('resumen-total-bs').textContent = totalBS;
            
            modal.style.display = 'flex';
        }

        function cerrarResumen() {
            document.getElementById('resumen-modal').style.display = 'none';
        }

        function cerrarConfirmacion() {
            document.getElementById('confirmacion-modal').style.display = 'none';
        }

        // --- FUNCI√ìN CLAVE: AGREGA AMBOS TOTALES AL MENSAJE ---
        function enviarPedidoWhatsApp() {
            const items = obtenerItemsPedidos();
            const totalUSD = document.getElementById('total-usd').textContent;
            const totalBS = document.getElementById('total-bs').textContent;
            const simboloMoneda = currencyCode;

            let mensaje = `üêæ ¬°Hola, Perrokeros! Quiero realizar un pedido:\n\n`;
            items.forEach(item => { mensaje += `* ${item.cantidad}x ${item.nombre}\n`; });
            
            // Incluye ambos totales
            mensaje += `\n*TOTAL ESTIMADO:*`;
            mensaje += `\n* ${simboloMoneda}${totalUSD}`;
            mensaje += `\n* Bs. ${totalBS} (Tasa BCV: 1${simboloMoneda} = Bs. ${BCV_RATE_ACTUAL.toFixed(4)})`;
            mensaje += '\n\nPor favor, necesito confirmar el pedido y los detalles de pago. ¬°Gracias! ü¶¥';

            const mensajeCodificado = encodeURIComponent(mensaje);
            const urlWhatsApp = `https://wa.me/${NUMERO_WHATSAPP}?text=${mensajeCodificado}`;
            
            window.open(urlWhatsApp, '_blank');
            cerrarResumen();
            document.getElementById('confirmacion-modal').style.display = 'flex';
        }

        window.onload = cargarMenu; 

    </script>

</body>
</html>
